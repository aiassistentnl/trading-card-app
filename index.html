<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Card Uploader</title>
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-green: #30D158;
            --ios-red: #FF453A;
            --ios-orange: #FF9F0A;
            
            --background-primary: #000000;
            --background-secondary: #1C1C1E;
            --background-tertiary: #2C2C2E;
            
            --surface-primary: rgba(28, 28, 30, 0.8);
            --surface-elevated: rgba(44, 44, 46, 0.95);
            
            --text-primary: #FFFFFF;
            --text-secondary: rgba(235, 235, 245, 0.6);
            --text-tertiary: rgba(235, 235, 245, 0.3);
            
            --fill-secondary: rgba(120, 120, 128, 0.16);
            --fill-tertiary: rgba(118, 118, 128, 0.12);
            
            --separator-non-opaque: rgba(84, 84, 88, 0.6);
            
            --radius-medium: 12px;
            --radius-large: 16px;
            --radius-xl: 24px;
            
            --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.16), 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-large: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--background-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            -webkit-font-smoothing: antialiased;
            line-height: 1.47059;
            touch-action: manipulation;
        }
        
        .app-container {
            max-width: 393px;
            margin: 0 auto;
            padding: 0 16px;
            min-height: 100vh;
        }
        
        /* Navigation */
        .navigation-header {
            padding: 17px 0 11px;
            position: relative;
        }
        
        .nav-large-title {
            font-size: 34px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.37px;
            line-height: 1.2;
            margin-bottom: 8px;
        }
        
        .nav-subtitle {
            font-size: 17px;
            font-weight: 400;
            color: var(--text-secondary);
            letter-spacing: -0.41px;
        }
        
        .settings-button {
            position: absolute;
            top: 17px;
            right: 0;
            width: 44px;
            height: 44px;
            background: var(--fill-tertiary);
            border: none;
            border-radius: 22px;
            color: var(--ios-blue);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-button:hover {
            background: var(--fill-secondary);
            transform: scale(1.05);
        }
        
        .settings-icon {
            width: 18px;
            height: 18px;
            background: currentColor;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z'/%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z'/%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z'/%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z'/%3E%3C/svg%3E") center/contain no-repeat;
        }
        
        .photo-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--ios-red);
            color: white;
            border-radius: 12px;
            min-width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid var(--background-primary);
        }
        
        /* Sections */
        .section-group {
            margin-bottom: 32px;
        }
        
        .section-header {
            padding: 0 4px 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: -0.08px;
        }
        
        .clear-button {
            padding: 4px 8px;
            background: var(--fill-tertiary);
            border: none;
            border-radius: 6px;
            color: var(--ios-blue);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .clear-button:hover {
            background: var(--fill-secondary);
        }
        
        .clear-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Cards */
        .card {
            background: var(--surface-primary);
            border-radius: var(--radius-large);
            backdrop-filter: saturate(180%) blur(20px);
            border: 0.5px solid var(--separator-non-opaque);
            overflow: hidden;
        }
        
        .card-elevated {
            background: var(--surface-elevated);
            box-shadow: var(--shadow-large);
        }
        
        .card-row {
            padding: 16px;
            border-bottom: 0.5px solid var(--separator-non-opaque);
        }
        
        .card-row:last-child {
            border-bottom: none;
        }
        
        /* Upload Zone */
        .upload-zone {
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: var(--fill-secondary);
            border: 2px dashed var(--separator-non-opaque);
            border-radius: var(--radius-large);
            margin: 16px;
        }
        
        .upload-zone:hover {
            background: var(--fill-tertiary);
            border-color: var(--ios-blue);
            transform: translateY(-2px);
        }
        
        .upload-zone.dragover {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--ios-blue);
            transform: scale(1.02);
        }
        
        .upload-icon-container {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--ios-blue), rgba(191, 90, 242, 1));
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .upload-icon-container::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: var(--fill-secondary);
            border-radius: 38px;
        }
        
        .upload-icon {
            width: 32px;
            height: 32px;
            background: var(--ios-blue);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z'/%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 13a3 3 0 11-6 0 3 3 0 016 0z'/%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z'/%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 13a3 3 0 11-6 0 3 3 0 016 0z'/%3E%3C/svg%3E") center/contain no-repeat;
            position: relative;
            z-index: 1;
        }
        
        .upload-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.45px;
        }
        
        .upload-subtext {
            font-size: 16px;
            color: var(--text-secondary);
            letter-spacing: -0.32px;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-picker-button {
            margin: 16px;
            border-top: 0.5px solid var(--separator-non-opaque);
            padding-top: 16px;
        }
        
        /* Preview Grid */
        .preview-section {
            margin: 0 16px 16px;
            display: none;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }
        
        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-medium);
            overflow: hidden;
            background: var(--fill-secondary);
            box-shadow: var(--shadow-medium);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .preview-item:hover {
            transform: scale(1.05);
        }
        
        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-info {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            backdrop-filter: blur(10px);
        }
        
        .remove-button {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            opacity: 0;
        }
        
        .preview-item:hover .remove-button {
            opacity: 1;
        }
        
        .remove-button:hover {
            background: var(--ios-red);
            transform: scale(1.1);
        }
        
        .remove-button::before {
            content: '';
            width: 12px;
            height: 12px;
            background: currentColor;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/%3E%3C/svg%3E") center/contain no-repeat;
        }
        
        .price-check-button {
            position: absolute;
            bottom: 6px;
            left: 6px;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            opacity: 0;
        }
        
        .preview-item:hover .price-check-button {
            opacity: 1;
        }
        
        .price-check-button:hover {
            background: var(--ios-blue);
            transform: scale(1.1);
        }
        
        .price-check-button::before {
            content: '';
            width: 12px;
            height: 12px;
            background: currentColor;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1'/%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1'/%3E%3C/svg%3E") center/contain no-repeat;
        }
        
        /* Form Fields */
        .form-field {
            display: flex;
            flex-direction: column;
        }
        
        .field-label {
            font-size: 17px;
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.41px;
        }
        
        .text-input, .url-input, .number-input {
            background: var(--fill-secondary);
            border: none;
            border-radius: var(--radius-medium);
            padding: 16px;
            font-size: 17px;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s ease;
            letter-spacing: -0.41px;
        }
        
        .text-input:focus, .url-input:focus, .number-input:focus {
            outline: none;
            background: var(--fill-tertiary);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
        }
        
        .text-input::placeholder, .url-input::placeholder, .number-input::placeholder {
            color: var(--text-tertiary);
        }
        
        textarea.text-input {
            min-height: 100px;
            resize: vertical;
        }
        
        .price-field {
            position: relative;
        }
        
        .price-field::before {
            content: '€';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 17px;
            pointer-events: none;
            z-index: 1;
        }
        
        .price-field .number-input {
            padding-left: 36px;
            text-align: right;
            font-weight: 600;
        }
        
        .character-counter {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: var(--text-tertiary);
            background: var(--background-secondary);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        /* Buttons */
        .primary-button {
            background: linear-gradient(135deg, var(--ios-blue), rgba(191, 90, 242, 1));
            color: white;
            border: none;
            border-radius: var(--radius-large);
            padding: 18px 24px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.41px;
            margin: 24px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .primary-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-large);
        }
        
        .primary-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .primary-button:disabled {
            background: var(--fill-secondary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .settings-panel.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .settings-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface-elevated);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: 12px 16px calc(env(safe-area-inset-bottom) + 16px);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid var(--separator-non-opaque);
        }
        
        .settings-panel.visible .settings-content {
            transform: translateY(0);
        }
        
        .settings-handle {
            width: 36px;
            height: 5px;
            background: rgba(84, 84, 88, 0.6);
            border-radius: 2.5px;
            margin: 0 auto 20px;
        }
        
        .settings-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 24px;
            letter-spacing: -0.45px;
        }
        
        .close-button {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 16px;
            background: var(--fill-tertiary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .close-button:hover {
            background: var(--fill-secondary);
        }
        
        .close-button::before {
            content: '';
            width: 16px;
            height: 16px;
            background: currentColor;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/%3E%3C/svg%3E") center/contain no-repeat;
        }
        
        /* Camera Interface */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .camera-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .camera-header {
            position: absolute;
            top: env(safe-area-inset-top);
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .camera-title {
            color: white;
            font-size: 17px;
            font-weight: 600;
        }
        
        .camera-close-button {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .camera-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .camera-close-button::before {
            content: '';
            width: 20px;
            height: 20px;
            background: currentColor;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/%3E%3C/svg%3E") center/contain no-repeat;
        }
        
        .photo-count-badge {
            background: var(--fill-tertiary);
            color: var(--text-primary);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            border: 0.5px solid var(--separator-non-opaque);
        }
        
        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-controls {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom) + 20px);
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 1001;
        }
        
        .camera-settings {
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 25px;
            backdrop-filter: blur(20px);
        }
        
        .macro-toggle {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .macro-toggle.active {
            background: var(--ios-red);
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .zoom-button {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .zoom-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .zoom-display {
            color: white;
            font-size: 14px;
            font-weight: 600;
            min-width: 45px;
            text-align: center;
        }
        
        .capture-section {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .capture-button {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .capture-button:active {
            transform: scale(0.95);
        }
        
        .capture-inner {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            transition: all 0.1s ease;
        }
        
        .capture-button:active .capture-inner {
            transform: scale(0.9);
        }
        
        .camera-info {
            text-align: center;
            color: white;
            font-size: 14px;
        }
        
        /* Status Messages */
        .status-banner {
            position: fixed;
            top: calc(env(safe-area-inset-top) + 60px);
            left: 16px;
            right: 16px;
            padding: 16px 20px;
            border-radius: var(--radius-large);
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            backdrop-filter: saturate(180%) blur(20px);
            border: 0.5px solid var(--separator-non-opaque);
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
            box-shadow: var(--shadow-large);
        }
        
        .status-banner.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .status-success {
            background: rgba(48, 209, 88, 0.15);
            color: var(--ios-green);
            border-color: rgba(48, 209, 88, 0.3);
        }
        
        .status-error {
            background: rgba(255, 69, 58, 0.15);
            color: var(--ios-red);
            border-color: rgba(255, 69, 58, 0.3);
        }
        
        .status-loading {
            background: rgba(0, 122, 255, 0.15);
            color: var(--ios-blue);
            border-color: rgba(0, 122, 255, 0.3);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 122, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--ios-blue);
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease;
        }
        
        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .app-container {
                padding-top: max(16px, env(safe-area-inset-top));
                padding-bottom: max(24px, env(safe-area-inset-bottom));
            }
            
            .text-input, .url-input, .number-input, .primary-button {
                -webkit-appearance: none;
            }
        }
        
        @media (max-width: 430px) {
            .app-container {
                padding-left: 12px;
                padding-right: 12px;
            }
            
            .nav-large-title {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="navigation-header">
            <h1 class="nav-large-title">Card Uploader</h1>
            <p class="nav-subtitle">Upload je kaarten naar eBay</p>
            <button class="settings-button" onclick="toggleSettings()">
                <span class="settings-icon"></span>
                <div class="photo-counter" id="photoCounter">0</div>
            </button>
        </div>
        
        <div class="section-group">
            <div class="section-header">
                <h2 class="section-title">Foto's</h2>
                <button class="clear-button" onclick="clearAllPhotos()" id="clearAllBtn" disabled>Wissen</button>
            </div>
            <div class="card card-elevated animate-slide-up">
                <div class="upload-zone" onclick="startCamera()" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="upload-icon-container">
                        <div class="upload-icon"></div>
                    </div>
                    <div class="upload-text">Voeg foto's toe</div>
                    <div class="upload-subtext">Klik voor camera of sleep bestanden hierheen</div>
                </div>
                
                <div class="file-picker-button">
                    <button class="primary-button" onclick="selectFiles()" style="margin: 0; padding: 12px; background: var(--fill-tertiary); color: var(--ios-blue); width: 100%;">
                        Bestanden selecteren
                    </button>
                </div>
                
                <input type="file" id="fileInput" accept="image/*" multiple>
            </div>
            
            <div class="preview-section" id="previewSection">
                <div class="preview-grid" id="previewContainer"></div>
            </div>
        </div>
        
        <div class="section-group">
            <div class="section-header">
                <h2 class="section-title">Details</h2>
            </div>
            <div class="card animate-slide-up">
                <div class="card-row">
                    <div class="form-field">
                        <label class="field-label">Beschrijving</label>
                        <textarea id="description" class="text-input" 
                                  placeholder="Beschrijf je kaart..."
                                  maxlength="500"></textarea>
                        <div class="character-counter" id="descriptionCounter">0/500</div>
                    </div>
                </div>
                <div class="card-row">
                    <div class="form-field">
                        <label class="field-label">Prijs</label>
                        <div class="price-field">
                            <input type="number" id="price" class="number-input" 
                                   placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="primary-button" onclick="uploadCards()" id="uploadBtn" disabled>
            Upload naar eBay
        </button>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel" onclick="closeSettings(event)">
        <div class="settings-content" onclick="event.stopPropagation()">
            <div class="settings-handle"></div>
            <button class="close-button" onclick="closeSettings()"></button>
            <h2 class="settings-title">Instellingen</h2>
            
            <div class="form-field">
                <label class="field-label">Upload Webhook</label>
                <input type="url" id="webhookUrl" class="url-input" 
                       placeholder="https://your-webhook-url.com"
                       value="https://labgrowns.nl/webhook/60406624-b200-493c-aaf3-23f068a09829">
            </div>
            
            <div class="form-field" style="margin-top: 20px;">
                <label class="field-label">Price Check Webhook</label>
                <input type="url" id="priceCheckUrl" class="url-input" 
                       placeholder="https://your-pricecheck-url.com"
                       value="https://labgrowns.nl/webhook-test/63ce1602-efe3-4d49-bae6-14f3717ce028">
            </div>
            
            <button class="primary-button" onclick="testPriceCheckWebhook()" style="margin: 20px 0 0; padding: 12px;">
                Test Price Check Webhook
            </button>
            
            <button class="primary-button" onclick="priceCheckAllPhotos()" id="priceCheckAllBtn" disabled style="margin: 12px 0 0; padding: 12px; background: var(--fill-tertiary); color: var(--ios-blue);">
                Price Check Alle Foto's
            </button>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-header">
            <div class="camera-title">Camera</div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span class="photo-count-badge" id="cameraPhotoCount">0 foto's</span>
                <button class="camera-close-button" onclick="closeCamera()"></button>
            </div>
        </div>
        <video class="camera-video" id="cameraVideo" autoplay playsinline></video>
        <div class="camera-controls">
            <!-- Camera Settings -->
            <div class="camera-settings">
                <button class="macro-toggle" id="macroToggle" onclick="toggleMacro()">
                    Macro UIT
                </button>
                <div class="zoom-controls">
                    <button class="zoom-button" onclick="adjustZoom(-0.1)">−</button>
                    <div class="zoom-display" id="zoomDisplay">1.0x</div>
                    <button class="zoom-button" onclick="adjustZoom(0.1)">+</button>
                </div>
                <button onclick="setZoom(1.7)" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 15px; color: white; font-size: 12px; font-weight: 600; cursor: pointer;">
                    1.7x
                </button>
            </div>
            
            <!-- Capture Controls -->
            <div class="capture-section">
                <button onclick="closeCamera()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px);">
                    Sluit Camera
                </button>
                <button class="capture-button" onclick="capturePhoto()">
                    <div class="capture-inner"></div>
                </button>
                <div style="width: 120px;"></div> <!-- Spacer for symmetry -->
            </div>
            
            <div class="camera-info">
                <div>Tap om foto te maken</div>
                <div style="font-size: 12px; opacity: 0.7;">Gebruik macro en zoom controls hierboven</div>
            </div>
        </div>
    </div>

    <!-- Status Banner -->
    <div class="status-banner" id="statusBanner">
        <span id="statusText">Klaar</span>
    </div>

    <script>
        let selectedFiles = [];
        let cameraStream = null;
        let uploadInProgress = false;
        let currentZoom = 1.0;
        let macroEnabled = false;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            updateCharacterCounter();
            updateUploadButton();
            updatePhotoCounter();
            
            // Auto-save setup
            document.getElementById('description').addEventListener('input', () => {
                updateCharacterCounter();
                scheduleAutoSave();
            });
            document.getElementById('price').addEventListener('input', scheduleAutoSave);
            document.getElementById('webhookUrl').addEventListener('input', updateUploadButton);
            document.getElementById('webhookUrl').addEventListener('change', saveSettings);
            document.getElementById('priceCheckUrl').addEventListener('change', saveSettings);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Close camera if open
                    const cameraModal = document.getElementById('cameraModal');
                    if (cameraModal.classList.contains('visible')) {
                        closeCamera();
                    }
                    // Close settings if open
                    const settingsPanel = document.getElementById('settingsPanel');
                    if (settingsPanel.classList.contains('visible')) {
                        closeSettings();
                    }
                }
                
                // Camera controls (only when camera is open)
                const cameraModal = document.getElementById('cameraModal');
                if (cameraModal.classList.contains('visible')) {
                    switch(e.key) {
                        case ' ': // Spacebar to capture
                            e.preventDefault();
                            capturePhoto();
                            break;
                        case 'm': // M to toggle macro
                        case 'M':
                            e.preventDefault();
                            toggleMacro();
                            break;
                        case '+': // + to zoom in
                        case '=':
                            e.preventDefault();
                            adjustZoom(0.1);
                            break;
                        case '-': // - to zoom out
                        case '_':
                            e.preventDefault();
                            adjustZoom(-0.1);
                            break;
                    }
                }
            });
        });
        
        // Settings functions
        function loadSettings() {
            const savedUrl = localStorage.getItem('webhookUrl');
            const savedPriceCheckUrl = localStorage.getItem('priceCheckUrl');
            
            if (savedUrl) {
                document.getElementById('webhookUrl').value = savedUrl;
            }
            if (savedPriceCheckUrl) {
                document.getElementById('priceCheckUrl').value = savedPriceCheckUrl;
            }
        }
        
        function saveSettings() {
            localStorage.setItem('webhookUrl', document.getElementById('webhookUrl').value);
            localStorage.setItem('priceCheckUrl', document.getElementById('priceCheckUrl').value);
        }
        
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.add('visible');
        }
        
        function closeSettings(event) {
            if (event && event.target !== event.currentTarget) return;
            const panel = document.getElementById('settingsPanel');
            panel.classList.remove('visible');
            saveSettings();
        }
        
        // Auto-save functions
        let autoSaveTimeout;
        
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveDraft();
            }, 2000);
        }
        
        function saveDraft() {
            const draft = {
                description: document.getElementById('description').value,
                price: document.getElementById('price').value,
                timestamp: Date.now()
            };
            localStorage.setItem('cardUploadDraft', JSON.stringify(draft));
        }
        
        // Camera functions
        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatusBanner('Camera niet beschikbaar op dit apparaat', 'error');
                return;
            }
            
            try {
                // Start with default constraints (no macro, 1x zoom)
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: 'continuous',
                        focusDistance: { min: 0.3, ideal: 1.0 }, // No macro initially
                        zoom: { ideal: 1.0 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const cameraModal = document.getElementById('cameraModal');
                const video = document.getElementById('cameraVideo');
                
                video.srcObject = cameraStream;
                cameraModal.classList.add('visible');
                
                // Reset controls
                currentZoom = 1.0;
                macroEnabled = false;
                updateCameraControls();
                updateCameraPhotoCount();
                
            } catch (error) {
                console.error('Camera error:', error);
                showStatusBanner('Camera kon niet worden geopend', 'error');
                selectFiles();
            }
        }
        
        function closeCamera() {
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.remove('visible');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            showStatusBanner('Camera gesloten', 'success');
        }
        
        // Camera control functions
        async function toggleMacro() {
            if (!cameraStream) return;
            
            macroEnabled = !macroEnabled;
            
            try {
                const videoTrack = cameraStream.getVideoTracks()[0];
                const constraints = {
                    focusMode: 'continuous',
                    zoom: { ideal: currentZoom }
                };
                
                if (macroEnabled) {
                    // Enable macro: allow close focus
                    constraints.focusDistance = { min: 0.05, ideal: 0.1 }; // 5cm to 10cm
                } else {
                    // Disable macro: prevent close focus
                    constraints.focusDistance = { min: 0.3, ideal: 1.0 }; // 30cm to 1m
                }
                
                await videoTrack.applyConstraints({ advanced: [constraints] });
                updateCameraControls();
                
                const status = macroEnabled ? 'Macro AAN' : 'Macro UIT';
                showStatusBanner(status, 'success');
                
            } catch (error) {
                console.error('Macro toggle error:', error);
                showStatusBanner('Macro aanpassing mislukt', 'error');
            }
        }
        
        async function adjustZoom(delta) {
            if (!cameraStream) return;
            
            const newZoom = Math.max(1.0, Math.min(2.0, currentZoom + delta)); // Max 2.0x zoom
            if (newZoom === currentZoom) return;
            
            try {
                const videoTrack = cameraStream.getVideoTracks()[0];
                const constraints = {
                    zoom: { ideal: newZoom },
                    focusMode: 'continuous'
                };
                
                // Apply current macro setting
                if (macroEnabled) {
                    constraints.focusDistance = { min: 0.05, ideal: 0.1 };
                } else {
                    constraints.focusDistance = { min: 0.3, ideal: 1.0 };
                }
                
                await videoTrack.applyConstraints({ advanced: [constraints] });
                currentZoom = newZoom;
                updateCameraControls();
                
            } catch (error) {
                console.error('Zoom error:', error);
                showStatusBanner('Zoom aanpassing mislukt', 'error');
            }
        }
        
        async function setZoom(targetZoom) {
            if (!cameraStream) return;
            
            const newZoom = Math.max(1.0, Math.min(2.0, targetZoom));
            
            try {
                const videoTrack = cameraStream.getVideoTracks()[0];
                const constraints = {
                    zoom: { ideal: newZoom },
                    focusMode: 'continuous'
                };
                
                // Apply current macro setting
                if (macroEnabled) {
                    constraints.focusDistance = { min: 0.05, ideal: 0.1 };
                } else {
                    constraints.focusDistance = { min: 0.3, ideal: 1.0 };
                }
                
                await videoTrack.applyConstraints({ advanced: [constraints] });
                currentZoom = newZoom;
                updateCameraControls();
                showStatusBanner(`Zoom ingesteld op ${newZoom.toFixed(1)}x`, 'success');
                
            } catch (error) {
                console.error('Set zoom error:', error);
                showStatusBanner('Zoom aanpassing mislukt', 'error');
            }
        }
        
        function updateCameraControls() {
            const macroToggle = document.getElementById('macroToggle');
            const zoomDisplay = document.getElementById('zoomDisplay');
            
            if (macroToggle) {
                macroToggle.textContent = macroEnabled ? 'Macro AAN' : 'Macro UIT';
                macroToggle.classList.toggle('active', macroEnabled);
            }
            
            if (zoomDisplay) {
                zoomDisplay.textContent = `${currentZoom.toFixed(1)}x`;
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            if (!video) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Flash effect
            video.style.filter = 'brightness(1.5)';
            setTimeout(() => {
                video.style.filter = 'none';
            }, 150);
            
            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            canvas.toBlob((blob) => {
                const file = new File([blob], `card_${Date.now()}.jpg`, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                
                handleFiles([file]);
                updateCameraPhotoCount();
                
            }, 'image/jpeg', 0.95);
        }
        
        function updateCameraPhotoCount() {
            const badge = document.getElementById('cameraPhotoCount');
            if (badge) {
                badge.textContent = `${selectedFiles.length} foto's`;
            }
        }
        
        // File handling
        function selectFiles() {
            document.getElementById('fileInput').click();
        }
        
        document.getElementById('fileInput').addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        }
        
        async function handleFiles(files) {
            if (uploadInProgress) return;
            
            showStatusBanner('Foto\'s verwerken...', 'loading');
            
            const validFiles = Array.from(files).filter(file => {
                if (!file.type.startsWith('image/')) {
                    showStatusBanner(`${file.name} is geen geldige afbeelding`, 'error');
                    return false;
                }
                if (file.size > 50 * 1024 * 1024) {
                    showStatusBanner(`${file.name} is te groot (max 50MB)`, 'error');
                    return false;
                }
                return true;
            });
            
            const processedFiles = [];
            for (const file of validFiles) {
                try {
                    const cropped = await autoCropCard(file);
                    const compressed = await compressImage(cropped);
                    processedFiles.push(compressed);
                } catch (error) {
                    console.error('Processing error:', error);
                    processedFiles.push(file);
                }
            }
            
            const wasEmpty = selectedFiles.length === 0;
            selectedFiles = [...selectedFiles, ...processedFiles];
            
            // Auto price check: verstuur eerste foto naar workflow zodra deze is ingeladen
            if (wasEmpty && processedFiles.length > 0) {
                showStatusBanner('Eerste foto wordt verstuurd voor price check...', 'loading');
                await performAutoPriceCheck(processedFiles[0]);
            }
            
            updatePreview();
            updatePhotoCounter();
            updateUploadButton();
            
            if (processedFiles.length > 0) {
                const totalSize = processedFiles.reduce((sum, file) => sum + file.size, 0);
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
                showStatusBanner(`${processedFiles.length} foto${processedFiles.length > 1 ? '\'s' : ''} toegevoegd (${totalSizeMB}MB)`, 'success');
            }
        }
        
        // Auto-crop function
        async function autoCropCard(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const cropRect = detectCardBounds(ctx, img.width, img.height);
                    
                    if (cropRect) {
                        const croppedCanvas = document.createElement('canvas');
                        const croppedCtx = croppedCanvas.getContext('2d');
                        
                        croppedCanvas.width = cropRect.width;
                        croppedCanvas.height = cropRect.height;
                        
                        croppedCtx.drawImage(
                            img,
                            cropRect.x, cropRect.y, cropRect.width, cropRect.height,
                            0, 0, cropRect.width, cropRect.height
                        );
                        
                        croppedCanvas.toBlob((blob) => {
                            const croppedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            resolve(croppedFile);
                        }, 'image/jpeg', 0.95);
                    } else {
                        resolve(file);
                    }
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        function detectCardBounds(ctx, width, height) {
            try {
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                const gray = new Array(width * height);
                for (let i = 0; i < data.length; i += 4) {
                    const grayValue = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    gray[i / 4] = grayValue;
                }
                
                let minX = width, maxX = 0, minY = height, maxY = 0;
                let foundEdges = false;
                const threshold = 30;
                
                for (let y = 0; y < height; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const current = gray[y * width + x];
                        const prev = gray[y * width + (x - 1)];
                        const next = gray[y * width + (x + 1)];
                        
                        if (Math.abs(current - prev) > threshold || Math.abs(current - next) > threshold) {
                            minX = Math.min(minX, x);
                            maxX = Math.max(maxX, x);
                            minY = Math.min(minY, y);
                            maxY = Math.max(maxY, y);
                            foundEdges = true;
                        }
                    }
                }
                
                for (let x = 0; x < width; x++) {
                    for (let y = 1; y < height - 1; y++) {
                        const current = gray[y * width + x];
                        const prev = gray[(y - 1) * width + x];
                        const next = gray[(y + 1) * width + x];
                        
                        if (Math.abs(current - prev) > threshold || Math.abs(current - next) > threshold) {
                            minX = Math.min(minX, x);
                            maxX = Math.max(maxX, x);
                            minY = Math.min(minY, y);
                            maxY = Math.max(maxY, y);
                            foundEdges = true;
                        }
                    }
                }
                
                if (!foundEdges) return null;
                
                const padding = Math.min(width, height) * 0.05;
                minX = Math.max(0, minX - padding);
                minY = Math.max(0, minY - padding);
                maxX = Math.min(width, maxX + padding);
                maxY = Math.min(height, maxY + padding);
                
                const cropWidth = maxX - minX;
                const cropHeight = maxY - minY;
                
                if (cropWidth < width * 0.3 || cropHeight < height * 0.3) {
                    return null;
                }
                
                const aspectRatio = cropWidth / cropHeight;
                if (aspectRatio < 0.5 || aspectRatio > 2.0) {
                    return null;
                }
                
                return {
                    x: Math.round(minX),
                    y: Math.round(minY),
                    width: Math.round(cropWidth),
                    height: Math.round(cropHeight)
                };
                
            } catch (error) {
                console.warn('Auto-crop failed:', error);
                return null;
            }
        }
        
        // Image compression
        function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    let { width, height } = img;
                    const maxWidth = 1920;
                    const maxHeight = 1920;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', 0.8);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // Price check functions
        async function performAutoPriceCheck(file) {
            const priceCheckUrl = document.getElementById('priceCheckUrl').value.trim();
            
            if (!priceCheckUrl || !isValidUrl(priceCheckUrl)) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('filename', file.name);
                formData.append('timestamp', new Date().toISOString());
                formData.append('action', 'pricecheck');
                
                const response = await fetch(priceCheckUrl, {
                    method: 'POST',
                    body: formData,
                });
                
                if (response.ok) {
                    showStatusBanner('Price check geopend op je computer', 'success');
                }
                
            } catch (error) {
                console.error('Price check error:', error);
            }
        }
        
        // Manual price check for specific photo
        async function manualPriceCheck(fileIndex) {
            if (fileIndex >= selectedFiles.length) return;
            
            const file = selectedFiles[fileIndex];
            showStatusBanner('Price check wordt uitgevoerd...', 'loading');
            await performAutoPriceCheck(file);
        }
        
        // Price check all photos
        async function priceCheckAllPhotos() {
            if (selectedFiles.length === 0) return;
            
            showStatusBanner(`Price check van ${selectedFiles.length} foto's wordt uitgevoerd...`, 'loading');
            
            for (let i = 0; i < selectedFiles.length; i++) {
                await performAutoPriceCheck(selectedFiles[i]);
                // Small delay between requests
                if (i < selectedFiles.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            showStatusBanner(`Price check van ${selectedFiles.length} foto's voltooid`, 'success');
        }
        
        // Test price check webhook
        async function testPriceCheckWebhook() {
            const priceCheckUrl = document.getElementById('priceCheckUrl').value.trim();
            
            if (!priceCheckUrl) {
                showStatusBanner('Voer eerst een Price Check URL in', 'error');
                return;
            }
            
            if (!isValidUrl(priceCheckUrl)) {
                showStatusBanner('Ongeldige Price Check URL', 'error');
                return;
            }
            
            try {
                showStatusBanner('Price Check webhook testen...', 'loading');
                
                const formData = new FormData();
                formData.append('test', 'true');
                formData.append('message', 'Test vanuit Card Uploader');
                formData.append('timestamp', new Date().toISOString());
                
                const response = await fetch(priceCheckUrl, {
                    method: 'POST',
                    body: formData,
                });
                
                if (response.ok) {
                    showStatusBanner('Price Check webhook werkt perfect!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Price check test error:', error);
                showStatusBanner(`Webhook test mislukt: ${error.message}`, 'error');
            }
        }
        
        // Preview functions
        function updatePreview() {
            const container = document.getElementById('previewContainer');
            const section = document.getElementById('previewSection');
            
            if (selectedFiles.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'preview-item';
                
                const img = document.createElement('img');
                img.className = 'preview-image';
                img.src = URL.createObjectURL(file);
                img.alt = `Preview ${index + 1}`;
                
                const info = document.createElement('div');
                info.className = 'preview-info';
                info.textContent = `${Math.round(file.size / 1024)}KB`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-button';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeFile(index);
                };
                
                const priceCheckBtn = document.createElement('button');
                priceCheckBtn.className = 'price-check-button';
                priceCheckBtn.title = 'Price check';
                priceCheckBtn.onclick = (e) => {
                    e.stopPropagation();
                    manualPriceCheck(index);
                };
                
                previewDiv.appendChild(img);
                previewDiv.appendChild(info);
                previewDiv.appendChild(removeBtn);
                previewDiv.appendChild(priceCheckBtn);
                container.appendChild(previewDiv);
            });
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
            updatePhotoCounter();
            updateUploadButton();
        }
        
        function clearAllPhotos() {
            if (selectedFiles.length === 0) return;
            
            if (confirm('Weet je zeker dat je alle foto\'s wilt verwijderen?')) {
                selectedFiles = [];
                updatePreview();
                updatePhotoCounter();
                updateUploadButton();
                document.getElementById('fileInput').value = '';
                showStatusBanner('Alle foto\'s verwijderd', 'success');
            }
        }
        
        // UI update functions
        function updatePhotoCounter() {
            const counter = document.getElementById('photoCounter');
            const clearBtn = document.getElementById('clearAllBtn');
            const priceCheckAllBtn = document.getElementById('priceCheckAllBtn');
            
            if (selectedFiles.length > 0) {
                counter.textContent = selectedFiles.length;
                counter.style.display = 'flex';
                clearBtn.disabled = false;
                if (priceCheckAllBtn) priceCheckAllBtn.disabled = false;
            } else {
                counter.style.display = 'none';
                clearBtn.disabled = true;
                if (priceCheckAllBtn) priceCheckAllBtn.disabled = true;
            }
        }
        
        function updateUploadButton() {
            const btn = document.getElementById('uploadBtn');
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            
            if (selectedFiles.length === 0 || !webhookUrl) {
                btn.disabled = true;
                btn.textContent = 'Upload naar eBay';
            } else {
                btn.disabled = false;
                btn.textContent = `Upload ${selectedFiles.length} foto${selectedFiles.length > 1 ? '\'s' : ''} naar eBay`;
            }
        }
        
        function updateCharacterCounter() {
            const field = document.getElementById('description');
            const counter = document.getElementById('descriptionCounter');
            const maxLength = field.getAttribute('maxlength') || '∞';
            counter.textContent = `${field.value.length}/${maxLength}`;
        }
        
        // Upload function
        async function uploadCards() {
            if (uploadInProgress) return;
            
            const webhookUrl = document.getElementById('webhookUrl').value.trim();
            const description = document.getElementById('description').value.trim();
            const price = document.getElementById('price').value;
            
            if (selectedFiles.length === 0) {
                showStatusBanner('Selecteer eerst één of meer foto\'s', 'error');
                return;
            }
            
            if (!webhookUrl) {
                showStatusBanner('Voer eerst je webhook URL in', 'error');
                toggleSettings();
                return;
            }
            
            if (!isValidUrl(webhookUrl)) {
                showStatusBanner('Voer een geldige webhook URL in', 'error');
                return;
            }
            
            uploadInProgress = true;
            updateUploadButton();
            showStatusBanner('Uploaden naar eBay...', 'loading');
            
            try {
                const formData = new FormData();
                
                selectedFiles.forEach((file, index) => {
                    formData.append(`image_${index}`, file);
                });
                
                formData.append('description', description);
                formData.append('price', price || '0');
                formData.append('timestamp', new Date().toISOString());
                formData.append('fileCount', selectedFiles.length.toString());
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    body: formData,
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                await response.json().catch(() => ({}));
                
                showStatusBanner(`${selectedFiles.length} foto${selectedFiles.length > 1 ? '\'s' : ''} succesvol geüpload naar eBay!`, 'success');
                
                // Reset form
                selectedFiles = [];
                document.getElementById('description').value = '';
                document.getElementById('price').value = '';
                document.getElementById('fileInput').value = '';
                updatePreview();
                updatePhotoCounter();
                updateCharacterCounter();
                
                // Clear draft
                localStorage.removeItem('cardUploadDraft');
                
            } catch (error) {
                console.error('Upload error:', error);
                showStatusBanner(`Upload mislukt: ${error.message}`, 'error');
            } finally {
                uploadInProgress = false;
                updateUploadButton();
            }
        }
        
        // Utility functions
        function showStatusBanner(message, type) {
            const banner = document.getElementById('statusBanner');
            const text = document.getElementById('statusText');
            
            banner.className = `status-banner status-${type}`;
            
            if (type === 'loading') {
                text.innerHTML = `<span class="loading-spinner"></span>${message}`;
            } else {
                text.textContent = message;
            }
            
            banner.classList.add('show');
            
            if (type !== 'loading') {
                setTimeout(() => {
                    banner.classList.remove('show');
                }, 4000);
            }
        }
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }
    </script>
</body>
</html>
